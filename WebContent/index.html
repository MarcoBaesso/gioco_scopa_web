<!DOCTYPE html PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN" "http://www.w3.org/TR/html4/loose.dtd">
<html>
<head>
<meta charset="UTF-8">
<link href="style/style.css" rel="stylesheet" type="text/css">
<script type="text/javascript" src="http://code.jquery.com/jquery.min.js"></script>
<script type="text/javascript" src="js/raphael.js"></script>
<title>gioco_scopa</title>
<script> 
  
	  /*var startTime = new Date().getTime(); // get the current time
5.
while (new Date().getTime() < startTime + 5000); // hog cpu
      //echo_service.close();*/  
  
var mazzo;
var paper;
var campo;
var tavolo;
var echo_service;
var array_carte_tavolo=new Array();
var array_carte_computer=new Array();
var array_carte_player=new Array();

function nuova_partita(){
	echo_service.send("newpartita");
};

function append(text){
	document.getElementById("eventi_websocket").insertAdjacentHTML('beforeend', 
	"<li>" + text + ";</li>");
};

function percorso_carta(carta){
	var percorso="data/immagini/carte/" + carta + ".png";
	//console.log(percorso);	
	return percorso;
};

function carta_tavolo_on_click(){
	append(this.carta);
};

function carta_player_on_click(){
	append(this.carta);
};

$(function(){
    	echo_service = new WebSocket('ws://localhost:9999/gioco_scopa_web/gioco'); 
    
   	echo_service.onmessage = function(event){
		//append(event.data);
		var json_msg=jQuery.parseJSON(event.data);
		var carte_tavolo;
		var carte_player;

		switch(json_msg.type) { 
		case "newpartita":
			carte_tavolo=json_msg.tavolo;
			var i=0;
			while(i<carte_tavolo.length) {
				from=paper.image(percorso_carta(carte_tavolo[i]),900,318,80,145);
				from.animate({x:45+85*i,y:327},2000,"linear");
				var card=from;
				card.carta=carte_tavolo[i];
				array_carte_tavolo[i]=card;
				card.click(carta_tavolo_on_click);
				console.log(card.carta);
  				i++;
 			} 

			carte_player=json_msg.player;
			i=0;
			while(i<carte_player.length){
				from=paper.image(percorso_carta("RETRO_AVVERSARIO"),900,318,80,145);
				from.animate({x:275+90*i,y:50},2000,"linear");
				array_carte_computer[i]=from;
				from=paper.image(percorso_carta(carte_player[i]),900,318,80,145);
				from.animate({x:275+90*i,y:605},2000,"linear");
				var card=from;
				card.carta=carte_player[i];
				array_carte_player[i]=card;
				card.click(carta_player_on_click);
				i++;
			}
			
			$("#turno").html("Turno: COMPUTER");

			echo_service.send("mossa_computer");
		break;
		case "mossa_computer":
		break;
		case "mossa_player":
		break;
		case "newset":
		break;
		default: return;
		}
	} 
    
   	echo_service.onopen = function(){
      		append("connessione effettuata");
            /*  setInterval(function(){ 
            	    var ping = "ping"; 
            	    echo_service.send("newpartita"); 
           	},10000);*/
    	} 
    
   	echo_service.onclose = function(){
      		append("connessione chiusa");
    	} 
    
    	echo_service.onerror = function(){
      		append("errore nella connessione");
    	}

	// crea CANVAS
	paper = Raphael(250, 50, 1000, 800);
	
	// crea sfondo
	campo = paper.rect(0, 0, 1000, 800);
	campo.attr("fill", "#66CC00");
	campo.attr("stroke", "#66CC00");
	var border_campo=paper.path("M0 0H1000 0");
	border_campo.attr("fill","#000000");
	border_campo.attr("stroke-width", "3");
	border_campo=paper.path("M0 0V0 800");
	border_campo.attr("fill","#000000");
	border_campo.attr("stroke-width", "3");
	border_campo=paper.path("M0 800H1000 800");
	border_campo.attr("fill","#000000");
	border_campo.attr("stroke-width", "3");
	border_campo=paper.path("M1000 0V1000 800");
	border_campo.attr("fill","#000000");
	border_campo.attr("stroke-width", "3");
	
	// crea mazzo
	mazzo=paper.image("data/immagini/carte/MAZZO.png", 900, 318, 88, 163)
	
	// crea tavolo
	tavolo=paper.rect(40, 255, 810 , 290);
	tavolo.attr("fill", "#FFFF33");
	tavolo.attr("stroke", "#FFFF33");
	var border_tavolo=paper.path("M40 255H850 255");
	border_tavolo.attr("fill","#000000");
	border_tavolo.attr("stroke-width", "3");
	border_tavolo=paper.path("M40 545H850 545");
	border_tavolo.attr("fill","#000000");
	border_tavolo.attr("stroke-width", "3");
	border_tavolo=paper.path("M40 0V40 800");
	border_tavolo.attr("fill","#000000");
	border_tavolo.attr("stroke-width", "3");
	border_tavolo=paper.path("M850 0V850 800");
	border_tavolo.attr("fill","#000000");
	border_tavolo.attr("stroke-width", "3");

	Element.prototype.carta=null;

});

</script> 
</head>
<body>

<h1 onClick="nuova_partita()">Nuova partita</h1>

<h2 id="turno">Turno:</h2>

<div id="punteggio">
<h1>Punteggio</h1>
	<table>
	<tr>
		<th></th>
  		<th>Computer</th>
  		<th>Player</th> 
	</tr>
	<tr>
		<td>Carte</td>
		<td></td>
		<td></td>
	</tr>
	<tr>		
		<td>Denari</td>
		<td></td>
		<td></td>
	</tr>
	<tr>
		<td>Re bello</td>
		<td></td>
		<td></td>
	</tr>
	<tr>
		<td>7 bello</td>
		<td></td>
		<td></td>
	</tr>
	<tr>
		<td>Primiera</td>
		<td></td>
		<td></td>
	</tr>
  		<td>Scope</td>
		<td></td>
		<td></td>	
	</tr>
</table>
</div>
<div>
<ul id="eventi_websocket"></ul>
</div>



</body>
</html>
